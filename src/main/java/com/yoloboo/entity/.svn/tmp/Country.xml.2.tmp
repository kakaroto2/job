<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC 
    "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="country">
	
	
	<!-- 获得国家列表  -->
	<select id="obtainCountry"   resultType="java.util.HashMap">
		select 
		  c.country_id as countryId,c.c_english as countryName ,c.c_simple as simpleName,
		  c.c_traditional as traditionalName,c.c_first_letter  as firstLetter,c.c_first_letter_china  as firstLetterChina
		from 
		  tb_country as c
	    order by
		  c.c_first_letter
		 
	</select>
	
	<!-- 获得首页国家列表  -->
	<select id="obtainCountryList"  parameterType="java.util.HashMap" resultType="java.util.HashMap">		
	<!-- select 
		  c.country_id as countryId,c.c_english as countryName ,c.c_simple as simpleName,
		  c.c_traditional as traditionalName,c.c_picture as countryPicture,
		  tnr.trn_notes_num as notesNum,tnr.trn_isno_new_notes as isnoRead  
		from 
		  tb_travel_notes_read as tnr,tb_country as c
		where
		  (tnr.country_id=c.country_id and  tnr.user_id=#{userId}) or 
		  exists(select tb_travel_notes.country_id from tb_travel_notes  where tb_travel_notes.user_id=#{userId} and tb_travel_notes.country_id=c.country_id)
	   GROUP BY  c.country_id 
	    order by
		  c.c_first_letter
		  limit
		${startIndex},${size}
		 -->	

select 
c.country_id as countryId,c.c_english as countryName ,c.c_simple as simpleName,
		  c.c_traditional as traditionalName,c.c_picture as countryPicture
 from tb_country c where exists(select tn.country_id from tb_travel_notes as tn where tn.country_id=c.country_id 
and (tn.user_id=#{userId} 
 or exists(select f.f_passive_people_id from  tb_friends f  where  f.f_initiative_people_id=#{userId} and f.f_passive_people_id=tn.user_id and f.f_isno_delete=0)

or exists(select u.user_id from tb_user u where u.user_id=tn.user_id and u.delete_flag=0 and (u.u_type=2 or u.u_type=3))))
ORDER BY c.c_first_letter asc limit ${startIndex},${size}

	</select>
	
	<!-- 获得首页国家列表  数量  -->
	<select id="obtainCountryListCount"  parameterType="java.util.HashMap" resultType="Integer">
		   
select count( DISTINCT tn.country_id) from tb_travel_notes as tn INNER JOIN tb_country c on tn.country_id=c.country_id where tn.user_id=#{userId}
 or exists(select f.f_passive_people_id from  tb_friends f  where  f.f_initiative_people_id=#{userId} and f.f_passive_people_id=tn.user_id and f.f_isno_delete=0)
or exists(select u.user_id from tb_user u where u.user_id=tn.user_id and u.delete_flag=0 and u.u_type=2)

	</select>


	<!-- 获得某个国家下面的贴士列表  自己的好友的贴士，达人的贴士，官方的贴士，，-->
	<select id="obtainOneCountryTipsList"  parameterType="java.util.HashMap" resultType="java.util.HashMap">
		SELECT 
		  tn.travel_notes_id as  travelNotesId, tn.tn_isno_complete as isnoComplete , 
		  tn.tn_comments_num as commentsNum, tn.tn_praise_num as praiseNum, tn.user_id as userId ,tn.tn_title as title
		FROM 
		  tb_travel_notes as tn 
		WHERE 
		tn.country_id=#{countryId} AND tn.tn_isno_delete=0
		<if test="themeId!=null">
			     and tn.theme_id=#{themeId} 
		</if>
		  AND (
		  (user_id IN
			(SELECT f.f_passive_people_id  
			 FROM tb_friends as f ,tb_user_travel_style as trs 
			 WHERE f.f_isno_delete=0 and f.f_initiative_people_id=#{userId}  
			   and trs.user_id=f.f_initiative_people_id  
			   <if test="travelStyleId!=null">
			     and trs.travel_style_id=#{travelStyleId}
		       </if>
			   )) 
			or 
		  (user_id IN
			(SELECT user_id FROM tb_user WHERE u_type=2 or u_type=3 OR user_id=#{userId}) ))
		order by
		   tn.travel_notes_id DESC
		limit
		  ${startIndex},${size}
	</select>

	<!-- 获得某个国家下面的贴士列表  -->
	<select id="obtainOneCountryTipsCount"  parameterType="java.util.HashMap" resultType="Integer">
		SELECT 
		  count(*)
		FROM 
		  tb_travel_notes as tn 
		WHERE 
		tn.country_id=#{countryId} AND tn.tn_isno_delete=0
		<if test="themeId!=null">
			     and tn.theme_id=#{themeId} 
		</if>
		  AND (
		  (user_id IN
			(SELECT f.f_passive_people_id  
			 FROM tb_friends as f ,tb_user_travel_style as trs 
			 WHERE f.f_isno_delete=0 and f.f_initiative_people_id=#{userId}  
			   and trs.user_id=f.f_initiative_people_id  
			   <if test="travelStyleId!=null">
			     and trs.travel_style_id=#{travelStyleId}
		       </if>
			   )) 
			or 
		  (user_id IN
			(SELECT user_id FROM tb_user WHERE u_type=2 or u_type=3 OR user_id=#{userId}) ))
		
	</select>



	<!-- 获得封面  -->
	<select id="obtainCoverPicture"  parameterType="Long" resultType="String">
		SELECT 
		  p_picture
		FROM 
		  tb_picture
		WHERE 
		  travel_notes_id=#{value} AND p_isno_cover=0
		limit
		  0,1
	</select>
     
    <!-- 获得用户 -->
	<select id="obtainUserInfo"  parameterType="Long" resultType="java.util.HashMap">
		SELECT 
		  u_nickname as nickname, u_picture as headPicture, user_id as userId
		FROM 
		  tb_user  
		WHERE 
		  user_id=#{value}
		limit
		  0,1
	</select>
	
    <!-- 获得旅游风格-->
	<select id="obtainStyleList"  parameterType="Long" resultType="java.util.HashMap">
		SELECT 
		  ts_black_picture as stylePicture, travel_style_id as styleId
		FROM 
		  tb_travel_style 
		WHERE 
		  travel_style_id 
		  in
		 (SELECT travel_style_id FROM tb_user_travel_style WHERE user_id=#{value})
	</select>
	

	
   <!-- 获取游记的某些信息 -->
	<select id="obtainNotesInfoToTips"  parameterType="String" resultType="java.util.HashMap">
	    SELECT 
		  tn.user_id as userId,tn.tn_isno_complete as isnoComplete,tn.tn_title as title,tn.tn_date as notesDate, t.t_name as name, t.t_simple_name as simpleName, t.t_traditional_name as  traditionalName
		, t.t_noclick_picture as noclickPicture,t.t_click_picture as clickPicture,
		  t.t_white_picture as whitePicture,t.t_black_picture as blackPicture,tn.country_id as countryId
		  FROM 
		   tb_travel_notes as tn LEFT JOIN tb_theme as t on tn.theme_id=t.theme_id
		WHERE 
		  tn.travel_notes_id=#{value}
		limit
		  0,1
	</select>
	
	
	<!-- 获得游记下面的贴士-->
	<select id="obtainOneNotesTipsList"  parameterType="java.util.HashMap" resultType="java.util.HashMap">

       SELECT 
		  p.picture_id as tipsId,p.p_address as address,p.p_description as content,p.p_picture as tipsPicture
		  ,p.p_praise_num as praiseNum,p.p_comments_num as commentsNum,p_date as tipsDate,p.p_isno_cover as isnoCover,
       ifnull(
           (select 
             sum( tt.tt_type) 
            from tb_travel_tips as tt 
            where tt.travel_tips_id in 
            (select  travel_tips_id from tb_travel_tips_picture as ttp where ttp.picture_id=p.picture_id) ),0) as type,
         (select count(*) from tb_praise pr where pr.user_id=#{userId} and pr.picture_id=p.picture_id)  as isPraised
		FROM 
		  tb_picture as p    
		WHERE 
		   p.travel_notes_id=#{travelNotesId} AND p.p_isno_delete=0 
		order by
		  p.p_date asc
		limit
		  ${startIndex},${size}
	</select>

	<!--  获得游记下面的贴士总数  -->
	<select id="obtainOneNotesTipsCount"  parameterType="java.util.HashMap" resultType="Integer">
		SELECT 
		  count(*)
		FROM 
		  tb_picture as p,tb_travel_tips as tt
		WHERE 
		   p.travel_notes_id=#{travelNotesId} AND p.p_isno_delete=0 and tt.travel_tips_id in 
		   (select travel_tips_id from tb_travel_tips_picture as ttp where ttp.picture_id=p.picture_id)
	</select>
	
	<!-- 获取贴士下面的评论 真删除-->
	<select id="obtainTipsCommentsList"  parameterType="java.util.HashMap" resultType="java.util.HashMap">
	    SELECT 
		   c.comments_id as commentsId,c.c_content as commentsContent,c.user_id as userId
		  ,u.u_picture as userPicture,u.u_nickname as userName,c.c_time as commentTime
		FROM 
		  tb_comments as c,tb_user as u
		WHERE 
		   c.picture_id=#{tipsId} and u.user_id=c.user_id
		order by
		   c.comments_id DESC
		limit
		  ${startIndex},${size}
	</select>

	
	
	<!--  获取贴士下面的评论 总数量  -->
	<select id="obtainTipsCommentsCount"  parameterType="java.util.HashMap" resultType="Integer">
		SELECT 
		  count(*)
		FROM 
		  tb_comments as c
	    WHERE 
		   c.picture_id=#{tipsId}
	</select>

	<!--  增加评论  -->
	<insert id="addTipsComments"  parameterType="java.util.HashMap" >
		insert INTO
		  tb_comments(c_content,c_time,picture_id,user_id)
        VALUES(#{commentsContent},#{commentsTime},#{tipsId},#{userId})
	</insert>
	
	<!--  更新评论数量   -->
	<update id="updateTipsCommentsNum"  parameterType="java.util.HashMap" >
		update tb_picture set p_comments_num=p_comments_num+${commentNum} where picture_id=#{tipsId}
	</update>
	<update id="updateNotesCommentsNum"  parameterType="java.util.HashMap" >
		update  tb_travel_notes set tn_comments_num = tn_comments_num+${commentNum}
		where travel_notes_id = (select travel_notes_id from tb_picture where picture_id=#{tipsId})
	</update>
	
	<!--  点赞   -->
	<insert id="addTipsPraise"  parameterType="java.util.HashMap" >
		insert INTO
		  tb_praise(p_time,picture_id,user_id)
        VALUES(#{praiseTime},#{tipsId},#{userId})
	</insert>
	
	<!--  更新图片点赞数量   -->
	<update id="updateTipsPraiseNum"  parameterType="java.util.HashMap" >
		update tb_picture set p_praise_num=p_praise_num+${praiseNum} where picture_id=#{tipsId}
	</update>
	<!--  更新游记点赞数量   -->
	<update id="updateNotesPraiseNum" parameterType="java.util.HashMap" >
	update  tb_travel_notes set tn_praise_num = tn_praise_num+${praiseNum}
	 where travel_notes_id = (select travel_notes_id from tb_picture where picture_id=#{tipsId})
	</update>
   <!--  获取主动ID  -->
	<select id="obtainInitiativeId"  parameterType="String" resultType="String">
		SELECT 
		  tn.user_id as userId
        FROM 
          tb_picture as p,tb_travel_notes as tn		  
        WHERE 
           p.travel_notes_id=tn.travel_notes_id and  p.picture_id=#{value}
        limit
        0,1  
	</select>
	
   <!--  根据验证码获取主动ID  -->
	<select id="obtainInitiativeIdByCode"  parameterType="String" resultType="Long">
		SELECT 
		   user_id
        FROM 
          tb_user
        WHERE 
          u_invitation_code=#{value}
        limit
        0,1  
	</select>
	
	
	
	
   <!--  保存上面的消息到推送表中 -->
	<insert id="addNotificationMessage"  parameterType="java.util.HashMap" >
    insert INTO
	  tb_notification_list  
    SET
      user_id=#{initiativeId},picture=#{headPicture},type=#{type},
      content=#{content},time=#{praiseTime},passive_id=#{userId}
	</insert>
	
	
	<!--  获取国家名称 英文  -->
	<select id="obtainCountryName"  parameterType="String" resultType="String">
		SELECT 
		  c_english as englishName
        FROM 
          tb_country  	  
        WHERE 
          country_id=#{value}
	</select>
	
	 <!--  获取国家名称 英 中文  -->
	<select id="obtainCountrySimpleName"  parameterType="String" resultType="String">
		SELECT 
		  c_simple as simpleName
        FROM 
          tb_country  	  
        WHERE 
          country_id=#{value}
	</select>
	
  <!--  获取国家名称 英  繁体   -->
	<select id="obtainCountryTraditionalName"  parameterType="String" resultType="String">
		SELECT 
		  c_traditional as traditionalName
        FROM 
          tb_country  	  
        WHERE 
          country_id=#{value}
	</select>


</mapper>